<div class="lessons-page" *ngIf="numericLevelId">
  
  <!-- Page Header -->
  <div class="page-header">
    <div class="header-content">
      <button mat-icon-button class="back-button" (click)="goBackToLevels()" matTooltip="Back to Levels">
        <mat-icon>arrow_back</mat-icon>
      </button>
      <div class="header-text">
        <h1 class="page-title">Manage Lessons</h1>
        <p class="page-subtitle">Level #{{ numericLevelId }}</p>
      </div>
    </div>
    <button 
      mat-raised-button 
      color="primary" 
      class="add-button"
      (click)="startAdding()" 
      [disabled]="isAdding || editRowId !== null || isLoading">
      <mat-icon>add</mat-icon>
      Add Lesson
    </button>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <mat-spinner diameter="50"></mat-spinner>
    <p>Loading lessons...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !isLoading" class="error-container">
    <mat-icon class="error-icon">error_outline</mat-icon>
    <p>{{ error }}</p>
    <button mat-raised-button color="primary" (click)="loadLessons()">Retry</button>
  </div>

  <!-- Lessons Table -->
  <div *ngIf="!isLoading && !error" class="table-container">
    <mat-card class="lessons-card">
      <mat-card-content class="card-content">
        
        <!-- Lessons Table -->
        <div class="table-wrapper">
          <table class="lessons-table">
            <thead>
              <tr>
                <th class="sequence-header">Sequence</th>
                <th class="name-header">English</th>
                <th class="name-header">Tamil</th>
                <th class="name-header">Sinhala</th>
                <th class="manage-header">Manage Activities</th>
                <th class="actions-header">Actions</th>
              </tr>
            </thead>
            <tbody>
              <!-- Add New Lesson Row -->
              <tr *ngIf="isAdding" class="table-row add-row">
                <td class="cell sequence-cell">
                  <mat-form-field appearance="outline" class="sequence-field">
                    <input 
                      matInput 
                      type="number" 
                      [(ngModel)]="newLesson.sequenceOrder"
                      placeholder="Order">
                  </mat-form-field>
                </td>
                <td class="cell name-cell">
                  <mat-form-field appearance="outline" class="edit-field">
                    <input 
                      matInput 
                      [ngModel]="newLesson.lessonName?.en || ''"
                      (ngModelChange)="onNewLessonNameFieldChange('en', $event)"
                      placeholder="English Name"
                      class="!text-base">
                  </mat-form-field>
                </td>
                <td class="cell name-cell">
                  <mat-form-field appearance="outline" class="edit-field">
                    <input 
                      matInput 
                      [ngModel]="newLesson.lessonName?.ta || ''"
                      (ngModelChange)="onNewLessonNameFieldChange('ta', $event)"
                      placeholder="தமிழ் Name"
                      class="!text-base">
                  </mat-form-field>
                </td>
                <td class="cell name-cell">
                  <mat-form-field appearance="outline" class="edit-field">
                    <input 
                      matInput 
                      [ngModel]="newLesson.lessonName?.si || ''"
                      (ngModelChange)="onNewLessonNameFieldChange('si', $event)"
                      placeholder="සිංහල Name"
                      class="!text-base">
                  </mat-form-field>
                </td>
                <td class="cell manage-cell">
                  <div class="cell-value placeholder">—</div>
                </td>
                <td class="cell actions-cell">
                  <div class="action-buttons">
                    <button 
                      mat-icon-button 
                      color="primary"
                      (click)="saveLesson()"
                      [disabled]="!newLesson.lessonName || !newLesson.sequenceOrder"
                      matTooltip="Save">
                      <mat-icon>check</mat-icon>
                    </button>
                    <button 
                      mat-icon-button 
                      (click)="cancelEdit()"
                      matTooltip="Cancel">
                      <mat-icon>close</mat-icon>
                    </button>
                  </div>
                </td>
              </tr>

              <tr *ngFor="let lesson of lessons" class="table-row" [class.editing]="editRowId === lesson.lessonId">
                
                <!-- Sequence Order -->
                <td class="cell sequence-cell">
                  <div *ngIf="editRowId !== lesson.lessonId" class="cell-value">
                    {{ lesson.sequenceOrder }}
                  </div>
                  <mat-form-field *ngIf="editRowId === lesson.lessonId" appearance="outline" class="edit-field">
                    <input 
                      matInput 
                      type="number" 
                      [(ngModel)]="editedLesson!.sequenceOrder"
                      placeholder="Order">
                  </mat-form-field>
                </td>

                <!-- English Name -->
                <td class="cell name-cell" [attr.colspan]="editRowId === lesson.lessonId ? 3 : 1">
                  <div *ngIf="editRowId !== lesson.lessonId" class="cell-value lesson-name">
                    {{ (lesson.lessonName && lesson.lessonName.en) || '-' }}
                  </div>
                  <div *ngIf="editRowId === lesson.lessonId" class="edit-name-wrapper">
                    <app-multilingual-input
                      [value]="editedLesson!.lessonName || { en: '', ta: '', si: '' }"
                      [label]="'Lesson Name'"
                      [placeholder]="{ en: 'Enter lesson name', ta: 'பாடம் பெயரை உள்ளிடவும்', si: 'පාඩමේ නම ඇතුළත් කරන්න' }"
                      [required]="true"
                      (valueChange)="onEditedLessonNameChange($event)">
                    </app-multilingual-input>
                  </div>
                </td>
                <!-- Tamil Name -->
                <td *ngIf="editRowId !== lesson.lessonId" class="cell name-cell">
                  <div class="cell-value lesson-name">
                    {{ (lesson.lessonName && lesson.lessonName.ta) || '-' }}
                  </div>
                </td>
                <!-- Sinhala Name -->
                <td *ngIf="editRowId !== lesson.lessonId" class="cell name-cell">
                  <div class="cell-value lesson-name">
                    {{ (lesson.lessonName && lesson.lessonName.si) || '-' }}
                  </div>
                </td>

                <!-- Manage Activities -->
                <td class="cell manage-cell">
                  <a 
                    mat-raised-button 
                    color="accent"
                    [routerLink]="['/activities']"
                    [queryParams]="{lessonId: lesson.lessonId}"
                    matTooltip="Manage Activities"
                    class="manage-button">
                    <mat-icon>list</mat-icon>
                    Manage Activities
                  </a>
                </td>

                <!-- Actions -->
                <td class="cell actions-cell">
                  <div *ngIf="editRowId !== lesson.lessonId" class="action-buttons">
                    <button 
                      mat-icon-button 
                      color="primary"
                      (click)="startEditing(lesson)"
                      [disabled]="isAdding || isLoading"
                      matTooltip="Edit">
                      <mat-icon>edit</mat-icon>
                    </button>
                    <button 
                      mat-icon-button 
                      color="warn"
                      (click)="deleteLesson(lesson)"
                      [disabled]="isAdding || isLoading"
                      matTooltip="Delete">
                      <mat-icon>delete</mat-icon>
                    </button>
                  </div>
                  <div *ngIf="editRowId === lesson.lessonId" class="action-buttons">
                    <button 
                      mat-icon-button 
                      color="primary"
                      (click)="saveLesson(lesson)"
                      [disabled]="!editedLesson?.lessonName || !editedLesson?.sequenceOrder"
                      matTooltip="Save">
                      <mat-icon>check</mat-icon>
                    </button>
                    <button 
                      mat-icon-button 
                      (click)="cancelEdit()"
                      matTooltip="Cancel">
                      <mat-icon>close</mat-icon>
                    </button>
                  </div>
                </td>
              </tr>

              <!-- Empty State -->
              <tr *ngIf="lessons.length === 0 && !isAdding" class="empty-row">
                <td colspan="6" class="empty-cell">
                  <div class="empty-state">
                    <mat-icon>book_outline</mat-icon>
                    <p>No lessons found. Click "Add Lesson" to create one.</p>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

      </mat-card-content>
    </mat-card>
  </div>

</div>

<!-- Error Page -->
<div class="error-page" *ngIf="!numericLevelId">
  <mat-card class="error-card">
    <mat-card-content>
      <mat-icon class="error-icon-large">error_outline</mat-icon>
      <h2>Error: No Level ID provided</h2>
      <p>Please select a level to manage lessons.</p>
      <button 
        mat-raised-button 
        color="primary" 
        (click)="goBackToLevels()">
        <mat-icon>arrow_back</mat-icon>
        Back to Levels
      </button>
    </mat-card-content>
  </mat-card>
</div>
