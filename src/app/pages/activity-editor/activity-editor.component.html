<div class="activity-editor-page">
    <div class="header">
        <div class="actions">
            <button
                mat-stroked-button
                class="back-button"
                (click)="goBack()"
                matTooltip="Back to Activities">
                <mat-icon>arrow_back</mat-icon>
                Back to Activities
            </button>
            <div class="actions-spacer"></div>
            <button mat-raised-button style="background-color: #346E8C; color: white;" (click)="handleSave()">Save Activity</button>
        </div>
    </div>
  
    <div class="content" *ngIf="!isLoading && activity">
  
        <!-- ⭐ TOP 2-ROW FORM GRID -->
        <div class="top-form-grid">

            <div class="form-item">
                <label>Name in Tamil</label>
                <input
                    type="text"
                    class="form-input font-noto-sans-tamil"
                    [ngModel]="activity!.title?.ta || ''"
                    (ngModelChange)="updateTitleField('ta', $event)"
                    placeholder="Name in Tamil">
            </div>

            <div class="form-item">
                <label>Name in English</label>
                <input
                    type="text"
                    class="form-input"
                    [ngModel]="activity!.title?.en || ''"
                    (ngModelChange)="updateTitleField('en', $event)"
                    placeholder="Name in English">
            </div>

            <div class="form-item">
                <label>Name in Sinhala</label>
                <input
                    type="text"
                    class="form-input font-noto-sans-sinhala"
                    [ngModel]="activity!.title?.si || ''"
                    (ngModelChange)="updateTitleField('si', $event)"
                    placeholder="Name in Sinhala">
            </div>

            <div class="form-item">
                <label>Sequence No.</label>
                <input
                    type="number"
                    class="form-input"
                    [ngModel]="activity!.sequenceOrder || 0"
                    (ngModelChange)="updateSequenceOrder($event)"
                    placeholder="e.g., 001">
            </div>

            <div class="form-item">
                <label>Main Activity</label>
                <div class="select-shell" [class.disabled]="isStructureSelectionLocked">
                    <select
                        class="form-input select-input"
                        [disabled]="isStructureSelectionLocked"
                        [ngModel]="activity!.mainActivityId || 0"
                        (ngModelChange)="updateMainActivityId($event)">
                        <option [value]="0" disabled>Select Main Activity</option>
                        <option *ngFor="let ma of mainActivities" [value]="ma.id">
                            {{ ma.name }}
                        </option>
                    </select>
                    <mat-icon>expand_more</mat-icon>
                </div>
                <small class="hint-text" *ngIf="mainActivityLockMessage">
                    {{ mainActivityLockMessage }}
                </small>
            </div>

            <div class="form-item">
                <label>Activity Type</label>
                <div class="select-shell" [class.disabled]="isStructureSelectionLocked || !(activity!.mainActivityId)">
                    <select
                        class="form-input select-input"
                        [disabled]="isStructureSelectionLocked || !(activity!.mainActivityId)"
                        [ngModel]="activity!.activityTypeId || 0"
                        (ngModelChange)="updateActivityTypeId($event)">
                        <option [value]="0" disabled>Select Activity Type</option>
                        <option *ngFor="let at of getDisplayActivityTypes()" [value]="at.activityTypeId">
                            {{ at.activityName }}
                        </option>
                    </select>
                    <mat-icon>expand_more</mat-icon>
                </div>
                <small class="hint-text" *ngIf="activityTypeLockMessage">
                    {{ activityTypeLockMessage }}
                </small>
            </div>

        </div>
        <!-- END 2 ROW TOP GRID -->
  
  
        <!-- ⭐ EXISTING GRID LAYOUT -->
        <div class="activity-grid">
  
            <!-- LEFT COLUMN -->
            <div class="column column-form">
                <section class="panel template-panel">
                    <div class="panel-header">
                        <h3>JSON Template</h3>
                        <button 
                            mat-stroked-button 
                            color="accent"
                            (click)="handleCopyTemplate()"
                            [disabled]="!(activity.activityTypeId || 0) || (activity.activityTypeId || 0) <= 0">
                            <mat-icon>content_copy</mat-icon>
                            COPY
                        </button>
                    </div>
  
                    <p class="panel-subtitle">
                        Select an Activity Type to view and copy its required JSON structure.
                    </p>
  
                    <div class="template-content" *ngIf="(activity.activityTypeId || 0) > 0; else noTemplate">
                        <pre><code>{{ getActivityTemplate(activity.activityTypeId || 0) }}</code></pre>
                    </div>
  
                    <ng-template #noTemplate>
                        <div class="no-template">
                            <p>Please select an Activity Type to view its template.</p>
                        </div>
                    </ng-template>
  
                </section>
            </div>
  
            <!-- MIDDLE COLUMN -->
            <div class="column column-editor">
                <section class="panel exercises-panel">
                    <div class="panel-header">
                        <h3>Exercises</h3>
                        <span class="badge">{{ exercises.length || 0 }}</span>
                    </div>
  
                    <div class="exercise-editor-wrapper">
                        <app-exercise-editor
                            [exercises]="exercises"
                            [pageSize]="exercisePageSize"
                            [activityId]="activityId"
                            [activityTypeId]="activity.activityTypeId || 0"
                            [expandedExercise]="expandedExercise"
                            (updateExercise)="handleUpdateExercise($event.exerciseId, $event.jsonData)"
                            (deleteExercise)="handleDeleteExercise($event)"
                            (previewExercise)="handlePreviewExercise($event)"
                            (expansionChange)="expandedExercise = $event.isExpanded ? $event.index : false">
                        </app-exercise-editor>
                    </div>

                    <button
                        mat-raised-button
                        color="accent"
                        (click)="handleAddExercise()"
                        [disabled]="!activity.activityTypeId || (activity.activityTypeId || 0) <= 0"
                        class="add-exercise-btn">
                        <mat-icon>add_circle_outline</mat-icon>
                        Add Exercise
                    </button>
                </section>
            </div>
  
            <!-- RIGHT COLUMN -->
            <div class="column column-preview">
                <section class="panel preview-panel">
                    <div class="panel-header">
                        <h3>Activity Preview</h3>
                    </div>
  
                    <div class="preview-wrapper">
                        <app-device-preview 
                          [activityData]="previewContent || activity">
                        </app-device-preview>
                    </div>
                </section>
            </div>
  
        </div>
    </div>
  
    <mat-spinner *ngIf="isLoading" class="loading-spinner"></mat-spinner>
  </div>
  