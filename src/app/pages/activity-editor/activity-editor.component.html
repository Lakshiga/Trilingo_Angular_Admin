<div class="activity-editor-page">
  <div class="header">
    <h1>{{ isEditMode ? 'Edit Activity #' + activityId : 'Add New Activity' }}</h1>
    
    <div class="actions">
      <button 
        mat-button 
        (click)="goBack()">
        ‚Üê BACK TO LIST
      </button>
      <button 
        mat-raised-button 
        color="primary"
        (click)="handleSave()">
        üíæ SAVE ENTIRE ACTIVITY
      </button>
    </div>
  </div>
  
  <div class="content" *ngIf="!isLoading && activity">
    <app-sidebar-language-manager></app-sidebar-language-manager>
    <div class="grid-container">
      <!-- Column 1: Activity Details Form -->
      <div class="form-column">
        <mat-card>
          <mat-card-header>
            <mat-card-title>Activity Details</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <app-activity-form
              [activityData]="activity"
              [mainActivities]="mainActivities"
              [activityTypes]="activityTypes"
              (dataChange)="handleFormChangeWrapper($event)">
            </app-activity-form>
          </mat-card-content>
        </mat-card>
      </div>
      
      <!-- Column 2: JSON Template & Exercises -->
      <div class="editor-column">
        <div class="template-section">
          <div class="template-header">
            <h3>JSON Template</h3>
            <button 
              mat-raised-button 
              color="accent"
              (click)="handleCopyTemplate()"
              [disabled]="!(activity?.activityTypeId || 0) || (activity?.activityTypeId || 0) <= 0">
              <mat-icon>content_copy</mat-icon>
              COPY TEMPLATE
            </button>
          </div>
          <p class="template-description">
            Select an Activity Type from the form to see its required JSON structure.
            Click "COPY TEMPLATE" to copy this structure to your clipboard.
          </p>
          <div class="template-content" *ngIf="(activity?.activityTypeId || 0) > 0; else noTemplate">
            <pre><code>{{ getActivityTemplate(activity?.activityTypeId || 0) }}</code></pre>
          </div>
          <ng-template #noTemplate>
            <div class="no-template">
              <p>Please select an Activity Type to view its template.</p>
            </div>
          </ng-template>
        </div>
        
        <div class="exercises-section">
          <h3>Exercises</h3>
          <app-exercise-editor
            [exercises]="exercises"
            [activityId]="activityId"
            [activityTypeId]="activity?.activityTypeId || 0"
            [expandedExercise]="expandedExercise"
            (addExercise)="handleAddExercise()"
            (updateExercise)="handleUpdateExercise($event.exerciseId, $event.jsonData)"
            (deleteExercise)="handleDeleteExercise($event)"
            (previewExercise)="handlePreviewExercise($event)"
            (expansionChange)="expandedExercise = $event.isExpanded ? $event.index : false">
          </app-exercise-editor>
        </div>
      </div>
      
      <!-- Column 3: Device Preview -->
      <div class="preview-column">
        <app-device-preview [activityData]="previewContent || activity"></app-device-preview>
      </div>
    </div>
  </div>
  
  <mat-spinner *ngIf="isLoading" class="loading-spinner"></mat-spinner>
</div>