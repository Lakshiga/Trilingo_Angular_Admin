<div class="activity-editor-container">

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <mat-spinner diameter="60" class="spinner"></mat-spinner>
    <p class="loading-text">Loading activity editor...</p>
  </div>

  <!-- Main Content -->
  <div *ngIf="!isLoading && activity" class="main-content">
    
    <!-- Left Column: Activity Form -->
    <section class="column column-form column-scroll">
      <div class="panel-card sticky-panel">
        <div class="panel-header">
          <h2 class="panel-title">
            <mat-icon>edit</mat-icon>
            Activity Details
          </h2>
        </div>
        <div class="panel-body">
          <app-activity-form
            [activityData]="activity"
            [mainActivities]="mainActivities"
            [activityTypes]="getDisplayActivityTypes()"
            [hasExercises]="exercises && exercises.length > 0"
            (dataChange)="handleFormChangeWrapper($event)">
          </app-activity-form>
        </div>
      </div>
    </section>
    
    <!-- Middle Column: JSON Template & Exercises -->
    <section class="column column-middle column-scroll">
      <div class="panel-card template-card" 
           [class.template-expanded]="(activity.activityTypeId || 0) > 0">
        <div class="panel-header">
          <h2 class="panel-title">
            <mat-icon>code</mat-icon>
            JSON Template
          </h2>
          <button 
            mat-icon-button
            class="icon-button"
            (click)="handleCopyTemplate()"
            [disabled]="!(activity.activityTypeId || 0) || (activity.activityTypeId || 0) <= 0"
            matTooltip="Copy Template">
            <mat-icon>content_copy</mat-icon>
          </button>
        </div>
        <div class="panel-body template-body scrollable-panel">
          <div *ngIf="(activity.activityTypeId || 0) > 0; else noTemplate" class="template-content">
            <pre class="code-block"><code>{{ getFormattedTemplate(activity.activityTypeId || 0) }}</code></pre>
          </div>
          <ng-template #noTemplate>
            <div class="empty-state">
              <mat-icon class="empty-icon">info</mat-icon>
              <p class="empty-text">Select an Activity Type to view its JSON template</p>
            </div>
          </ng-template>
        </div>
      </div>
      
      <div class="panel-card exercises-card grow-card">
        <div class="panel-header">
          <h2 class="panel-title">
            <mat-icon>fitness_center</mat-icon>
            Exercises
          </h2>
        </div>
        <div class="panel-body exercises-body scrollable-panel">
          <app-exercise-editor
            [exercises]="exercises"
            [activityId]="activityId"
            [activityTypeId]="activity.activityTypeId || 0"
            [expandedExercise]="expandedExercise"
            (addExercise)="handleAddExercise()"
            (updateExercise)="handleUpdateExercise($event.exerciseId, $event.jsonData)"
            (deleteExercise)="handleDeleteExercise($event)"
            (previewExercise)="handlePreviewExercise($event)"
            (expansionChange)="expandedExercise = $event.isExpanded ? $event.index : false">
          </app-exercise-editor>
        </div>
      </div>
    </section>

    <!-- Right Column: Device Preview -->
    <section class="column column-preview column-scroll">
      <div class="panel-card sticky-panel">
        <div class="panel-header">
          <h2 class="panel-title">
            <mat-icon>preview</mat-icon>
            Device Preview
          </h2>
        </div>
        <div class="panel-body preview-body scrollable-panel">
          <app-device-preview [activityData]="previewContent || activity"></app-device-preview>
        </div>
      </div>
    </section>

  </div>

  <!-- Footer Actions -->
  <div class="footer-actions">
    <button mat-stroked-button
            class="cancel-button"
            (click)="goBack()"
            [disabled]="isLoading">
      <mat-icon>close</mat-icon>
      <span>Cancel</span>
    </button>
    <button mat-flat-button
            class="save-button"
            (click)="handleSave()"
            [disabled]="isLoading">
      <mat-icon>save</mat-icon>
      <span>Save Activity</span>
    </button>
  </div>

</div>
