<div class="activities-page" *ngIf="numericLessonId">
  
  <!-- Page Header -->
  <div class="page-header">
    <div class="header-content">
      <button mat-icon-button class="back-button" (click)="goBack()" matTooltip="Back to Lessons">
        <mat-icon>arrow_back</mat-icon>
      </button>
      <div class="header-text">
        <h1 class="page-title">Manage Activities</h1>
        <p class="page-subtitle" *ngIf="lesson">Lesson: {{ languageService.getText(lesson.lessonName) }}</p>
      </div>
    </div>
    <button 
      mat-raised-button 
      color="primary" 
      class="add-button"
      (click)="startAdding()" 
      [disabled]="isAdding || isLoading">
      <mat-icon>add</mat-icon>
      Add Activity
    </button>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <mat-spinner diameter="50"></mat-spinner>
    <p>Loading activities...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !isLoading" class="error-container">
    <mat-icon class="error-icon">error_outline</mat-icon>
    <p>{{ error }}</p>
    <button mat-raised-button color="primary" (click)="loadData()">Retry</button>
  </div>

  <!-- Activities Table -->
  <div *ngIf="!isLoading && !error" class="table-container">
    <mat-card class="activities-card">
      <mat-card-content class="card-content">
        
        <app-sidebar-language-manager></app-sidebar-language-manager>
        
        <!-- Add New Activity Row -->
        <div *ngIf="isAdding" class="add-row">
          <div class="row-content">
            <div class="cell id-cell">
              <div class="cell-value">-</div>
            </div>
            <div class="cell title-cell">
              <app-multilingual-input
                [value]="newActivity.title || { en: '', ta: '', si: '' }"
                [label]="'Activity Title'"
                [placeholder]="{ en: 'Enter activity title', ta: 'செயல்பாட்டு தலைப்பை உள்ளிடவும்', si: 'ක්‍රියාකාරකමේ මාතෘකාව ඇතුළත් කරන්න' }"
                [required]="true"
                (valueChange)="onNewActivityTitleChange($event)">
              </app-multilingual-input>
            </div>
            <div class="cell sequence-cell">
              <mat-form-field appearance="outline" class="sequence-field">
                <input 
                  matInput 
                  type="number" 
                  [(ngModel)]="newActivity.sequenceOrder"
                  placeholder="Order">
              </mat-form-field>
            </div>
            <div class="cell type-cell">
              <mat-form-field appearance="outline" class="type-field">
                <mat-select [(ngModel)]="newActivity.activityTypeId" required>
                  <mat-option *ngFor="let at of activityTypes" [value]="at.id">
                    {{ at.name_en || at.name_ta || at.name_si }}
                  </mat-option>
                </mat-select>
              </mat-form-field>
            </div>
            <div class="cell preview-cell">
              <div class="cell-value">-</div>
            </div>
            <div class="cell manage-cell">
              <div class="cell-value">-</div>
            </div>
            <div class="cell actions-cell">
              <div class="action-buttons">
                <button 
                  mat-icon-button 
                  color="primary"
                  (click)="saveActivity()"
                  [disabled]="!newActivity.title || !newActivity.sequenceOrder || !newActivity.activityTypeId"
                  matTooltip="Save">
                  <mat-icon>check</mat-icon>
                </button>
                <button 
                  mat-icon-button 
                  (click)="cancelEdit()"
                  matTooltip="Cancel">
                  <mat-icon>close</mat-icon>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Activities Table -->
        <div class="table-wrapper">
          <table class="activities-table">
            <thead>
              <tr>
                <th class="id-header">ID</th>
                <th class="title-header">Activity Title</th>
                <th class="sequence-header">Sequence</th>
                <th class="type-header">Activity Type</th>
                <th class="preview-header">Preview</th>
                <th class="manage-header">Manage Exercises</th>
                <th class="actions-header">Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let activity of activities" class="table-row">
                
                <!-- ID -->
                <td class="cell id-cell">
                  <div class="cell-value">{{ activity.activityId }}</div>
                </td>

                <!-- Activity Title -->
                <td class="cell title-cell">
                  <div class="cell-value activity-title">
                    {{ getActivityDisplayName(activity) }}
                  </div>
                </td>

                <!-- Sequence Order -->
                <td class="cell sequence-cell">
                  <div class="cell-value">
                    {{ activity.sequenceOrder }}
                  </div>
                </td>

                <!-- Activity Type -->
                <td class="cell type-cell">
                  <div class="cell-value">
                    {{ activityTypeMap[activity.activityTypeId] || activity.activityTypeId }}
                  </div>
                </td>

                <!-- Preview -->
                <td class="cell preview-cell">
                  <button 
                    mat-raised-button 
                    color="primary"
                    (click)="openPreview(activity.activityId)"
                    matTooltip="Preview Activity"
                    class="preview-button">
                    <mat-icon>visibility</mat-icon>
                    Preview
                  </button>
                </td>

                <!-- Manage Exercises -->
                <td class="cell manage-cell">
                  <a 
                    mat-raised-button 
                    color="accent"
                    [routerLink]="['/exercises']"
                    [queryParams]="{activityId: activity.activityId}"
                    matTooltip="Manage Exercises"
                    class="manage-button">
                    <mat-icon>list</mat-icon>
                    Manage Exercises
                  </a>
                </td>

                <!-- Actions -->
                <td class="cell actions-cell">
                  <div class="action-buttons">
                    <a 
                      mat-icon-button 
                      color="primary"
                      [routerLink]="['/activity-edit']"
                      [queryParams]="{activityId: activity.activityId}"
                      [disabled]="isAdding || isLoading"
                      matTooltip="Edit">
                      <mat-icon>edit</mat-icon>
                    </a>
                    <button 
                      mat-icon-button 
                      color="warn"
                      (click)="deleteActivity(activity)"
                      [disabled]="isAdding || isLoading"
                      matTooltip="Delete">
                      <mat-icon>delete</mat-icon>
                    </button>
                  </div>
                </td>
              </tr>

              <!-- Empty State -->
              <tr *ngIf="activities.length === 0 && !isAdding" class="empty-row">
                <td colspan="7" class="empty-cell">
                  <div class="empty-state">
                    <mat-icon>assignment_outline</mat-icon>
                    <p>No activities found. Click "Add Activity" to create one.</p>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

      </mat-card-content>
    </mat-card>
  </div>

</div>

<!-- Error Page -->
<div class="error-page" *ngIf="!numericLessonId">
  <mat-card class="error-card">
    <mat-card-content>
      <mat-icon class="error-icon-large">error_outline</mat-icon>
      <h2>Error: No Lesson ID provided</h2>
      <p>Please select a lesson to manage activities.</p>
      <button 
        mat-raised-button 
        color="primary" 
        (click)="goBack()">
        <mat-icon>arrow_back</mat-icon>
        Back to Lessons
      </button>
    </mat-card-content>
  </mat-card>
</div>

<app-activity-player-modal
  [isOpen]="isPreviewOpen"
  (onClose)="closePreview()"
  [activity]="activityToPreview"
  [isLoading]="isPreviewLoading">
</app-activity-player-modal>
