<div class="w-full max-w-[1600px] mx-auto p-4 space-y-4">

  <!-- Page Header -->
  <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
    <div class="space-y-2">
      <h1 style="font-weight: 900;" class="text-4xl font-bold text-gray-900 tracking-tight">Manage Activity Types</h1>
    </div>
    
    <button mat-flat-button
            class="!bg-[#346E8C] hover:!bg-[#2a5a73] !text-white !rounded-xl !px-8 !py-3 !shadow-lg !shadow-[#346E8C]/25 disabled:opacity-50 transition-all duration-200 hover:scale-105 hover:shadow-xl"
            (click)="startAdding()" 
            [disabled]="isAdding || editRowId !== null || isLoading">
      <div class="flex items-center gap-2.5">
        <mat-icon class="!w-5 !h-5">add_circle</mat-icon>
        <span class="font-semibold text-base">Add Activity Type</span>
      </div>
    </button>
  </div>

  <!-- Main Content Card -->
  <div class="bg-white rounded-2xl shadow-2xl border border-gray-100 overflow-hidden relative">
    
    <!-- Loading Overlay -->
    <div *ngIf="isLoading" class="absolute inset-0 bg-white/95 z-50 flex flex-col items-center justify-center backdrop-blur-md">
      <div class="flex flex-col items-center gap-5">
        <mat-spinner diameter="60" class="!text-[#346E8C]"></mat-spinner>
        <p class="text-gray-700 font-semibold text-lg">Loading activity types...</p>
      </div>
    </div>

    <!-- Error State -->
    <div *ngIf="error && !isLoading" class="flex flex-col items-center justify-center py-32 text-center px-6">
      <div class="bg-red-50 p-6 rounded-2xl mb-6 shadow-lg">
        <mat-icon class="text-red-500 !w-12 !h-12 !text-[48px]">error_outline</mat-icon>
      </div>
      <h3 class="text-2xl font-bold text-gray-900 mb-3">Failed to load data</h3>
      <p class="text-gray-600 mb-8 max-w-md text-lg">{{ error }}</p>
      <button mat-stroked-button 
              class="!border-[#346E8C] !text-[#346E8C] hover:!bg-[#346E8C] hover:!text-white !rounded-xl !px-8 !py-3 !font-semibold transition-all"
              (click)="loadActivityTypes()">
        Try Again
      </button>
    </div>

    <!-- Table Container -->
    <div *ngIf="!error" class="overflow-x-auto">
      <table class="w-full">
        
        <!-- Table Head -->
        <thead class="bg-gradient-to-r from-[#346E8C] via-[#3d7ba0] to-[#346E8C] text-white shadow-lg">
          <tr>
            <th class="px-6 py-3 text-sm font-bold uppercase tracking-wider text-left">ID</th>
            <th class="px-6 py-3 text-sm font-bold uppercase tracking-wider text-left">Main Activity</th>
            <th class="px-6 py-3 text-sm font-bold uppercase tracking-wider text-left">English</th>
            <th class="px-6 py-3 text-sm font-bold uppercase tracking-wider text-left">Tamil</th>
            <th class="px-6 py-3 text-sm font-bold uppercase tracking-wider text-left">Sinhala</th>
            <th class="px-6 py-3 text-sm font-bold uppercase tracking-wider text-left">JSON Method</th>
            <th class="px-6 py-3 text-sm font-bold uppercase tracking-wider text-right">Actions</th>
          </tr>
        </thead>

        <tbody class="bg-white divide-y divide-gray-100">
          
          <!-- Add New Row Form -->
          <tr *ngIf="isAdding" class="bg-gradient-to-r from-blue-50 to-indigo-50 border-l-4 border-[#346E8C] animate-slideDown shadow-sm">
            <td class="px-6 py-3">
              <span class="inline-flex items-center justify-center w-10 h-10 rounded-lg bg-gradient-to-br from-[#346E8C] to-[#4a8fb8] text-white font-bold text-xs shadow-md">
                {{ getNextId() }}
              </span>
            </td>
            
            <td class="px-6 py-3">
              <select [(ngModel)]="selectedMainActivityId" 
                      class="modern-input" 
                      required>
                <option [value]="null">Select Main Activity</option>
                <option *ngFor="let mainActivity of mainActivities" 
                        [value]="mainActivity.id">
                  {{ mainActivity.name_en || mainActivity.name_ta || mainActivity.name_si }}
                </option>
              </select>
            </td>
            
            <td class="px-6 py-3">
              <input type="text" [(ngModel)]="newActivityType.name_en" 
                     class="modern-input" placeholder="Enter English Name" autofocus>
            </td>
            <td class="px-6 py-3">
              <input type="text" [(ngModel)]="newActivityType.name_ta" 
                     class="modern-input font-noto-sans-tamil" placeholder="Enter Tamil Name">
            </td>
            <td class="px-6 py-3">
              <input type="text" [(ngModel)]="newActivityType.name_si" 
                     class="modern-input font-noto-sans-sinhala" placeholder="Enter Sinhala Name">
            </td>
            
            <td class="px-6 py-3">
              <span class="text-gray-500 text-xs italic">Auto-generated on save</span>
            </td>
            
            <td class="px-6 py-3 text-right">
              <div class="flex items-center justify-end gap-3">
                <button (click)="cancelEdit()" 
                        class="action-btn-cancel" 
                        title="Cancel">
                  <mat-icon class="!w-5 !h-5">close</mat-icon>
                </button>
                <button (click)="saveActivityType()" 
                        class="action-btn-save" 
                        title="Save"
                        [disabled]="(!newActivityType.name_en && !newActivityType.name_ta && !newActivityType.name_si) || !selectedMainActivityId">
                  <mat-icon class="!w-5 !h-5">check</mat-icon>
                </button>
              </div>
            </td>
          </tr>

          <!-- Data Rows -->
          <tr *ngFor="let type of activityTypes" class="group bg-white hover:bg-[#c5d8e2] transition-all duration-200" [class.bg-blue-50]="editRowId === type.id" [class.border-l-4]="editRowId === type.id" [style.border-left-color]="editRowId === type.id ? '#346E8C' : 'transparent'">
            
            <!-- ID -->
            <td class="px-6 py-3">
              <span class="inline-flex items-center justify-center w-10 h-10 rounded-lg bg-gradient-to-br from-[#346E8C] to-[#4a8fb8] text-white font-bold text-xs shadow-md">
                {{ type.id }}
              </span>
            </td>

            <!-- Main Activity -->
            <td class="px-6 py-3">
              <span *ngIf="editRowId !== type.id" class="text-gray-900 font-bold group-hover:text-[#346E8C] text-sm">
                {{ getMainActivityName(type.mainActivityId) }}
              </span>
              <select *ngIf="editRowId === type.id" 
                      [(ngModel)]="editedMainActivityId"
                      class="modern-input">
                <option *ngFor="let mainActivity of mainActivities" 
                        [value]="mainActivity.id">
                  {{ mainActivity.name_en || mainActivity.name_ta || mainActivity.name_si }}
                </option>
              </select>
            </td>

            <!-- English Name -->
            <td class="px-6 py-3">
              <span *ngIf="editRowId !== type.id" class="text-gray-900 font-bold group-hover:text-[#346E8C] text-sm">
                {{ type.name_en || '-' }}
              </span>
              <input *ngIf="editRowId === type.id" 
                     [(ngModel)]="editedActivityType!.name_en" 
                     class="modern-input">
            </td>

            <!-- Tamil Name -->
            <td class="px-6 py-3 font-noto-sans-tamil">
              <span *ngIf="editRowId !== type.id" class="text-gray-900 font-bold group-hover:text-[#346E8C] text-sm">
                {{ type.name_ta || '-' }}
              </span>
              <input *ngIf="editRowId === type.id" 
                     [(ngModel)]="editedActivityType!.name_ta" 
                     class="modern-input">
            </td>

            <!-- Sinhala Name -->
            <td class="px-6 py-3 font-noto-sans-sinhala">
              <span *ngIf="editRowId !== type.id" class="text-gray-900 font-bold group-hover:text-[#346E8C] text-sm">
                {{ type.name_si || '-' }}
              </span>
              <input *ngIf="editRowId === type.id" 
                     [(ngModel)]="editedActivityType!.name_si" 
                     class="modern-input">
            </td>

            <!-- JSON Method -->
            <td class="px-6 py-3">
              <!-- View Mode -->
              <div *ngIf="editingJsonId !== type.id && editRowId !== type.id" class="flex items-center gap-2">
                <button 
                  (click)="startEditingJson(type)"
                  class="text-[#346E8C] hover:text-[#2a5a73] hover:underline text-xs font-semibold flex items-center gap-1"
                  [disabled]="isAdding || isLoading"
                  matTooltip="Edit JSON Method">
                  <mat-icon class="!w-4 !h-4">code</mat-icon>
                  <span>{{ type.jsonMethod ? 'View/Edit' : 'Add JSON' }}</span>
                </button>
              </div>

              <!-- Edit Mode (Inline JSON Editor) -->
              <div *ngIf="editingJsonId === type.id" class="space-y-2">
                <textarea
                  [(ngModel)]="editedJsonMethod"
                  (blur)="validateJson(editedJsonMethod)"
                  class="modern-input font-mono text-xs min-h-[120px] resize-y"
                  placeholder='Enter JSON method, e.g., {"type": "flashcard", "data": []}'
                ></textarea>
                <div *ngIf="jsonError" class="text-red-600 text-xs font-semibold bg-red-50 p-2 rounded">
                  {{ jsonError }}
                </div>
                <div class="flex items-center gap-2">
                  <button 
                    (click)="saveJsonMethod(type)"
                    class="action-btn-save text-xs px-3 py-1"
                    [disabled]="isLoading || !!jsonError">
                    <mat-icon class="!w-4 !h-4">check</mat-icon>
                    Save
                  </button>
                  <button 
                    (click)="cancelJsonEdit()"
                    class="action-btn-cancel text-xs px-3 py-1">
                    <mat-icon class="!w-4 !h-4">close</mat-icon>
                    Cancel
                  </button>
                </div>
              </div>

              <!-- Show JSON in edit mode (for name fields) -->
              <div *ngIf="editRowId === type.id && editingJsonId !== type.id" class="space-y-2">
                <div class="text-xs text-gray-600 mb-2">
                  <button 
                    (click)="startEditingJson(type)"
                    class="text-[#346E8C] hover:text-[#2a5a73] hover:underline font-semibold flex items-center gap-1">
                    <mat-icon class="!w-4 !h-4">code</mat-icon>
                    {{ editedActivityType?.jsonMethod ? 'Edit JSON' : 'Add JSON' }}
                  </button>
                </div>
                <pre *ngIf="editedActivityType?.jsonMethod" class="text-xs bg-gray-50 p-2 rounded max-h-32 overflow-auto font-mono">{{ formatJson(editedActivityType?.jsonMethod) }}</pre>
                <input 
                  *ngIf="editRowId === type.id"
                  type="hidden"
                  [(ngModel)]="editedActivityType!.jsonMethod">
              </div>
            </td>

            <!-- Actions -->
            <td class="px-6 py-3 text-right">
              <!-- View Mode Actions -->
              <div *ngIf="editRowId !== type.id" 
                   class="flex items-center justify-end gap-2">
                <button (click)="startEditing(type)" 
                        class="action-btn-edit"
                        matTooltip="Edit"
                        [disabled]="isAdding || isLoading">
                  <mat-icon class="!w-5 !h-5">edit</mat-icon>
                </button>
                <button (click)="deleteActivityType(type)" 
                        class="action-btn-delete"
                        matTooltip="Delete"
                        [disabled]="isAdding || isLoading">
                  <mat-icon class="!w-5 !h-5">delete</mat-icon>
                </button>
              </div>

              <!-- Edit Mode Actions -->
              <div *ngIf="editRowId === type.id" 
                   class="flex items-center justify-end gap-3">
                <button (click)="cancelEdit()" 
                        class="action-btn-cancel">
                  <mat-icon class="!w-5 !h-5">close</mat-icon>
                </button>
                <button (click)="saveActivityType(type)" 
                        class="action-btn-save"
                        [disabled]="!editedActivityType?.name_en && !editedActivityType?.name_ta && !editedActivityType?.name_si">
                  <mat-icon class="!w-5 !h-5">check</mat-icon>
                </button>
              </div>
            </td>
          </tr>

          <!-- Empty State -->
          <tr *ngIf="activityTypes.length === 0 && !isAdding && !isLoading">
            <td colspan="7" class="py-32 text-center">
              <div class="flex flex-col items-center justify-center">
                <div class="bg-gradient-to-br from-gray-50 to-blue-50 p-8 rounded-3xl mb-8 shadow-lg">
                  <mat-icon class="text-gray-400 !w-16 !h-16 !text-[64px]">extension</mat-icon>
                </div>
                <p class="text-gray-900 font-bold text-2xl mb-3">No activity types found</p>
                <p class="text-gray-600 text-lg mb-8 max-w-md">Get started by creating your first activity type.</p>
                <button class="text-[#346E8C] hover:text-[#2a5a73] hover:underline text-lg font-bold transition-colors flex items-center gap-2" 
                        (click)="startAdding()">
                  <mat-icon class="!w-5 !h-5">add_circle</mat-icon>
                  Create New Activity Type
                </button>
              </div>
            </td>
          </tr>

        </tbody>
      </table>
    </div>
  </div>
</div>
