<p>conversation-player works!</p>
<div class="p-4 sm:p-8 min-h-screen bg-gray-100 flex flex-col items-center w-full">

    @if (currentConversationData()) {
    <div class="max-w-4xl w-full bg-white shadow-2xl rounded-2xl overflow-hidden flex flex-col h-[600px] md:h-[80vh]">
  
      <!-- Header -->
      <header class="text-center p-4 bg-indigo-600 text-white border-b border-indigo-700 shrink-0 z-10">
        <h1 class="text-xl md:text-2xl font-bold">{{ text(content.title) }}</h1>
        <p class="text-xs md:text-sm italic opacity-90 mt-1">{{ text(content.instruction) }}</p>
      </header>
  
      <!-- Chat Area (Scrollable) -->
      <main class="flex-1 overflow-y-auto p-4 md:p-6 bg-slate-50 space-y-6 scroll-smooth relative" #chatContainer>
        
        <!-- Audio Element (Hidden) -->
        <audio #audioPlayer [src]="currentAudioUrl" style="display: none;" [autoplay]="false"></audio>
  
        <!-- Dialogues Loop -->
        @for (dialogue of currentConversationData()!.dialogues; track $index; let i = $index) {
          
          <!-- Logic variables -->
          @let speaker = getSpeaker(dialogue.speakerId);
          @let isLeft = speaker?.position === 'left';
          @let isActive = currentDialogueIndex() === i;
  
          <!-- Row Container (dialogue-row class used for auto-scroll) -->
          <div class="dialogue-row flex w-full mb-4 transition-all duration-500 ease-out"
               [ngClass]="{
                   'justify-start': isLeft, 
                   'justify-end': !isLeft, 
                   'opacity-40 grayscale': !isActive && isPlaying(), 
                   'opacity-100 scale-[1.02]': isActive
               }">
            
            <div class="flex max-w-[85%] md:max-w-[70%] gap-3 items-end"
                 [ngClass]="{'flex-row': isLeft, 'flex-row-reverse': !isLeft}">
              
              <!-- Avatar -->
              <div class="shrink-0 flex flex-col items-center mb-1">
                <img [src]="speaker?.avatarUrl" 
                     [alt]="text(speaker?.name)"
                     class="w-10 h-10 md:w-12 md:h-12 rounded-full border-2 shadow-sm object-cover bg-gray-200"
                     [ngClass]="{'border-indigo-400': isLeft, 'border-emerald-400': !isLeft}">
                <span class="text-[10px] text-gray-500 mt-1 font-bold">{{ text(speaker?.name) }}</span>
              </div>
  
              <!-- Bubble -->
              <div class="p-3 md:p-4 rounded-2xl shadow-md text-sm sm:text-base leading-relaxed relative transition-colors duration-300"
                   [ngClass]="{
                     'bg-white text-gray-800 rounded-bl-none': isLeft, 
                     'bg-indigo-100 text-gray-900 rounded-br-none': !isLeft,
                     'ring-2 ring-indigo-400 ring-offset-2 shadow-lg': isActive
                   }">
                {{ text(dialogue.content) }}
                
                <!-- Time Indicator (Debug/Optional) -->
                <!-- <span class="text-[9px] text-gray-400 absolute bottom-1 right-2">{{ getDialogueTime(dialogue) }}s</span> -->
              </div>
  
            </div>
          </div>
        }
      </main>
  
      <!-- Footer Controls -->
      <footer class="p-4 bg-white border-t border-gray-200 shrink-0 z-10">
        
        <!-- Progress Bar -->
        <div class="flex items-center justify-between space-x-4 mb-3">
          <span class="text-xs font-mono text-gray-500 w-10">{{ formatTime(currentTime()) }}</span>
          
          <input 
            type="range" 
            min="0" 
            [max]="duration()" 
            [value]="currentTime()" 
            (input)="seek($event)"
            class="w-full h-2 bg-indigo-100 rounded-lg appearance-none cursor-pointer range-lg"
          >
          
          <span class="text-xs font-mono text-gray-500 w-10 text-right">{{ formatTime(duration()) }}</span>
        </div>
  
        <!-- Play Button -->
        <div class="flex justify-center">
          <button mat-fab color="primary" class="!bg-indigo-600 hover:!bg-indigo-700 !shadow-lg transform active:scale-95 transition-transform" 
                  (click)="togglePlay()" aria-label="Play/Pause">
            <mat-icon class="!w-8 !h-8 !text-[32px] flex items-center justify-center -mt-1 ml-0.5">
                {{ isPlaying() ? 'pause' : 'play_arrow' }}
            </mat-icon>
          </button>
        </div>
  
      </footer>
  
    </div>
    } @else {
      <!-- Error State -->
      <div class="flex flex-col items-center justify-center h-64 text-gray-400 bg-white rounded-xl shadow p-8">
        <mat-icon class="text-5xl mb-2 text-gray-300">sentiment_dissatisfied</mat-icon>
        <p>உரையாடல் தரவு காணப்படவில்லை.</p>
      </div>
    }
  
  </div>