<div class="p-6 max-w-4xl mx-auto my-6 bg-white shadow-2xl rounded-xl">
    
    <header class="text-center mb-6">
        <h1 class="text-3xl font-extrabold text-indigo-700 mb-1">{{ text(content.title) }}</h1>
        <p class="text-gray-600 text-sm italic">{{ text(content.instruction) }}</p>
    </header>

    @if (currentQuestion()) {
        
        <div class="space-y-6">
            
            <!-- 1. The Sentence Area (Segments) -->
            <div class="p-6 border-2 border-indigo-200 rounded-lg bg-indigo-50 min-h-24">
                <p class="text-xl font-medium text-gray-800 flex flex-wrap gap-x-2">
                    @for (segment of segments(); track segment.id) {
                        
                        <!-- Static Text Segment -->
                        @if (segment.type === 'TEXT') {
                            <span class="whitespace-pre-wrap">{{ text(segment.content) }}</span>
                        }
                        
                        <!-- Blank Segment (Interactive) -->
                        @if (segment.type === 'BLANK') {
                            <span 
                                (click)="setActiveBlank($index)"
                                [ngClass]="{
                                    'bg-yellow-100 border-yellow-500 hover:shadow-md': activeBlankIndex() === $index && segment.status !== 'correct',
                                    'border-2 border-dashed border-gray-400': !segment.userAnswer,
                                    'bg-white border-indigo-500 cursor-pointer': !segment.userAnswer,
                                    'bg-green-100 border-green-600 text-green-800 font-semibold': segment.status === 'correct',
                                    'bg-red-100 border-red-600 text-red-800 font-semibold animate-pulse': segment.status === 'incorrect',
                                    'cursor-not-allowed': isFinished()
                                }"
                                class="inline-flex items-center justify-center min-w-[120px] h-10 px-3 rounded-md transition-all duration-200"
                            >
                                @if (segment.userAnswer) {
                                    <!-- Answer is filled -->
                                    <span 
                                        (click)="removeAnswerFromBlank($index, segment.userAnswer!)"
                                        class="truncate"
                                    >
                                        {{ segment.userAnswer }} 
                                        @if (!isFinished()) {
                                            <span class="text-xs text-gray-500 hover:text-red-500 ml-1"> (x)</span>
                                        }
                                    </span>
                                } @else {
                                    <!-- Blank Placeholder -->
                                    <span class="text-gray-500 text-sm italic">
                                        {{ segment.hint?.[currentLang] || '______' }}
                                    </span>
                                }
                            </span>
                        }
                    }
                </p>
            </div>
            
            <!-- 2. Message and Control Area -->
            <div class="flex justify-between items-center p-3 bg-gray-100 rounded-lg">
                <div class="font-medium text-gray-700" [ngClass]="{
                    'text-red-600': message().includes('தவறாக')
                }">
                    {{ message() }}
                </div>
                
                <button 
                    (click)="checkAnswers()" 
                    [disabled]="!isComplete() || isFinished()"
                    class="bg-indigo-600 text-white px-6 py-2 rounded-lg font-semibold shadow-md hover:bg-indigo-700 transition duration-150 disabled:bg-gray-400"
                >
                    விடைகளைச் சரிபார்க்கவும்
                </button>
            </div>
            
            <!-- 3. Options Container -->
            <div class="p-4 border rounded-lg bg-white">
                <h4 class="text-lg font-semibold mb-3 text-gray-800">Available Words (தேர்வு செய்ய)</h4>
                <div class="flex flex-wrap gap-3">
                    @for (option of options(); track $index) {
                        <button 
                            (click)="selectOption($index)"
                            [disabled]="!option.available || isFinished()"
                            [ngClass]="{
                                'bg-indigo-500 text-white shadow-lg hover:scale-105': option.available,
                                'bg-gray-300 text-gray-600 cursor-not-allowed opacity-60': !option.available
                            }"
                            class="px-4 py-2 rounded-full font-medium transition duration-150 ease-in-out"
                        >
                            {{ option.word }}
                        </button>
                    }
                </div>
            </div>
            
        </div>
    } @else {
        <p class="text-center text-red-500">தரவு இல்லை.</p>
    }
</div>